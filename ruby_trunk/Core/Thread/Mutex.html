<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Thread::Mutex &mdash; Core Ruby-2.5.0 dev</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/custom.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/common.css' />

<script type='text/javascript'>
  var pathId = "Thread::Mutex",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
        <a href='../../../index.html'>Home</a> &raquo; 
        <a href='../../index.html'>Ruby-2.5.0</a> &raquo; 
        <a href='../index.html'>Core</a> &raquo; 
        <a href='../_index.html#alpha_M'>Index (M)</a> &raquo; 
        <a href="../Thread.html" title="Thread (class)">Thread</a> &raquo; 
        <span class='title'><a id='t2_doc_top' href='#'>Mutex&nbsp;&#x25B2;</a></span>
      </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Thread::Mutex</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="../Object.html" title="Object (class)">Object</a></span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L1244'>thread_sync.c</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p><code>Mutex</code> implements a simple semaphore that can be used to
coordinate access to shared data from multiple concurrent threads.</p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>thread</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_semaphore'>semaphore</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'><a href="#new-class_method" title="Thread::Mutex.new (method)">new</a></span>

<span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='const'><a href="../Thread.html" title="Thread (class)">Thread</a></span><span class='period'>.</span><span class='id identifier rubyid_new'><a href="../Thread.html#new-class_method" title="Thread.new (method)">new</a></span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_semaphore'>semaphore</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span>
    <span class='comment'># access shared resource
</span>  <span class='rbrace'>}</span>
<span class='rbrace'>}</span>

<span class='id identifier rubyid_b'>b</span> <span class='op'>=</span> <span class='const'><a href="../Thread.html" title="Thread (class)">Thread</a></span><span class='period'>.</span><span class='id identifier rubyid_new'><a href="../Thread.html#new-class_method" title="Thread.new (method)">new</a></span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_semaphore'>semaphore</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span>
    <span class='comment'># access shared resource
</span>  <span class='rbrace'>}</span>
<span class='rbrace'>}</span></code></pre>

  </div>
</div>
</div>        

<h2 class='h2_sum' id='class_Method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title="new (class method)">.<strong>new</strong>  &#x21d2; Mutex </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Creates a new <code>Mutex</code>.</p></div>
    </div>
  </li>
</ul>
</div>
        

<h2 class='h2_sum' id='instance_Attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#locked%3F-instance_method" title="#locked? (instance method)">#<strong>locked?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns <code>true</code> if this lock is currently held by some thread.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#owned%3F-instance_method" title="#owned? (instance method)">#<strong>owned?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns <code>true</code> if this lock is currently held by current thread.</p></div>
    </div>
  </li>
</ul>
</div>
        

<h2 class='h2_sum' id='instance_Method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#lock-instance_method" title="#lock (instance method)">#<strong>lock</strong>  &#x21d2; self </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Attempts to grab the lock and waits if it isn&#39;t available.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#sleep-instance_method" title="#sleep (instance method)">#<strong>sleep</strong>(timeout = nil)  &#x21d2; Numeric </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Releases the lock and sleeps <code>timeout</code> seconds if it is given and non-nil
or forever.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#synchronize-instance_method" title="#synchronize (instance method)">#<strong>synchronize</strong>  &#x21d2; result of the block </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Obtains a lock, runs the block, and releases the lock when the block
completes.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#try_lock-instance_method" title="#try_lock (instance method)">#<strong>try_lock</strong>  &#x21d2; Boolean </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Attempts to obtain the lock and returns immediately.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#unlock-instance_method" title="#unlock (instance method)">#<strong>unlock</strong>  &#x21d2; self </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Releases the lock.</p></div>
    </div>
  </li>
</ul>
</div>
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>  &#x21d2; <code>Mutex</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Creates a new <code>Mutex</code></p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L109-L113'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num'>


109
110
111
112
113</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 109</span></pre>
<pre class='code cpp'>

static VALUE
mutex_initialize(VALUE self)
{
    return self;
}
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="locked?-instance_method">
  <h3 class='signature ro first'>
    #<strong>locked?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns <code>true</code> if this lock is currently held by some thread.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L127-L133'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num'>


127
128
129
130
131
132
133</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 127</span></pre>
<pre class='code cpp'>

VALUE
rb_mutex_locked_p(VALUE self)
{
    rb_mutex_t *mutex;
    GetMutexPtr(self, mutex);
    return mutex-&gt;th ? Qtrue : Qfalse;
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="owned?-instance_method">
  <h3 class='signature ro'>
    #<strong>owned?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns <code>true</code> if this lock is currently held by current thread.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L313-L326'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num'>


313
314
315
316
317
318
319
320
321
322
323
324
325
326</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 313</span></pre>
<pre class='code cpp'>

VALUE
rb_mutex_owned_p(VALUE self)
{
    VALUE owned = Qfalse;
    rb_thread_t *th = GET_THREAD();
    rb_mutex_t *mutex;

    GetMutexPtr(self, mutex);

    if (mutex-&gt;th == th)
	owned = Qtrue;

    return owned;
}
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="lock-instance_method">
  <h3 class='signature  first'>
    #<strong>lock</strong>  &#x21d2; <code>self</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Attempts to grab the lock and waits if it isn&#39;t available. Raises
<a href="../ThreadError.html" title="ThreadError (class)">::ThreadError</a> if <code>mutex</code> was locked by the current thread.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L238-L305'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num'>


238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 238</span></pre>
<pre class='code cpp'>

VALUE
rb_mutex_lock(VALUE self)
{
    rb_thread_t *th = GET_THREAD();
    rb_mutex_t *mutex;
    GetMutexPtr(self, mutex);

    /* When running trap handler */
    if (!mutex-&gt;allow_trap &amp;&amp; th-&gt;interrupt_mask &amp; TRAP_INTERRUPT_MASK) {
	rb_raise(rb_eThreadError, &quot;can&#39;t be called from trap context&quot;);
    }

    if (rb_mutex_trylock(self) == Qfalse) {
	if (mutex-&gt;th == th) {
	    rb_raise(rb_eThreadError, &quot;deadlock; recursive locking&quot;);
	}

	while (mutex-&gt;th != th) {
	    int interrupted;
	    enum rb_thread_status prev_status = th-&gt;status;
	    volatile int timeout_ms = 0;
	    struct rb_unblock_callback oldubf;

	    set_unblock_function(th, lock_interrupt, mutex, &amp;oldubf, FALSE);
	    th-&gt;status = THREAD_STOPPED_FOREVER;
	    th-&gt;locking_mutex = self;

	    native_mutex_lock(&amp;mutex-&gt;lock);
	    th-&gt;vm-&gt;sleeper++;
	    /*
	     * Carefully! while some contended threads are in lock_func(),
	     * vm-&gt;sleepr is unstable value. we have to avoid both deadlock
	     * and busy loop.
	     */
	    if ((vm_living_thread_num(th-&gt;vm) == th-&gt;vm-&gt;sleeper) &amp;&amp;
		!patrol_thread) {
		timeout_ms = 100;
		patrol_thread = th;
	    }

	    GVL_UNLOCK_BEGIN();
	    interrupted = lock_func(th, mutex, (int)timeout_ms);
	    native_mutex_unlock(&amp;mutex-&gt;lock);
	    GVL_UNLOCK_END();

	    if (patrol_thread == th)
		patrol_thread = NULL;

	    reset_unblock_function(th, &amp;oldubf);

	    th-&gt;locking_mutex = Qfalse;
	    if (mutex-&gt;th &amp;&amp; interrupted == 2) {
		rb_check_deadlock(th-&gt;vm);
	    }
	    if (th-&gt;status == THREAD_STOPPED_FOREVER) {
		th-&gt;status = prev_status;
	    }
	    th-&gt;vm-&gt;sleeper--;

	    if (mutex-&gt;th == th) mutex_locked(th, self);

	    if (interrupted) {
		RUBY_VM_CHECK_INTS_BLOCKING(th);
	    }
	}
    }
    return self;
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="sleep-instance_method">
  <h3 class='signature '>
    #<strong>sleep</strong>(timeout = nil)  &#x21d2; <a href="../Numeric.html" title="Numeric (class)">Numeric</a>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Releases the lock and sleeps <code>timeout</code> seconds if it is given and non-nil
or forever.  Raises <a href="../ThreadError.html" title="ThreadError (class)">::ThreadError</a> if <code>mutex</code> wasn&#39;t locked by the
current thread.</p>

<p>When the thread is next woken up, it will attempt to reacquire the lock.</p>

<p>Note that this method can wakeup without explicit <a href="../Thread.html#wakeup-instance_method" title="Thread#wakeup (method)">Thread#wakeup</a> call. For
example, receiving signal and so on.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L468-L475'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num'>


468
469
470
471
472
473
474
475</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 468</span></pre>
<pre class='code cpp'>

static VALUE
mutex_sleep(int argc, VALUE *argv, VALUE self)
{
    VALUE timeout;

    rb_scan_args(argc, argv, &quot;01&quot;, &amp;timeout);
    return rb_mutex_sleep(self, timeout);
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="synchronize-instance_method">
  <h3 class='signature '>
    #<strong>synchronize</strong>  &#x21d2; <code>result</code> <code>of</code> <code>the</code> <code>block</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Obtains a lock, runs the block, and releases the lock when the block
completes.  See the example under <code>Mutex</code>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L499-L507'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num'>


499
500
501
502
503
504
505
506
507</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 499</span></pre>
<pre class='code cpp'>

static VALUE
rb_mutex_synchronize_m(VALUE self, VALUE args)
{
    if (!rb_block_given_p()) {
	rb_raise(rb_eThreadError, &quot;must be called with a block&quot;);
    }

    return rb_mutex_synchronize(self, rb_yield, Qundef);
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="try_lock-instance_method">
  <h3 class='signature '>
    #<strong>try_lock</strong>  &#x21d2; <code>Boolean</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Attempts to obtain the lock and returns immediately. Returns <code>true</code> if the
lock was granted.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L154-L172'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num'>


154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 154</span></pre>
<pre class='code cpp'>

VALUE
rb_mutex_trylock(VALUE self)
{
    rb_mutex_t *mutex;
    VALUE locked = Qfalse;
    GetMutexPtr(self, mutex);

    native_mutex_lock(&amp;mutex-&gt;lock);
    if (mutex-&gt;th == 0) {
	rb_thread_t *th = GET_THREAD();
	mutex-&gt;th = th;
	locked = Qtrue;

	mutex_locked(th, self);
    }
    native_mutex_unlock(&amp;mutex-&gt;lock);

    return locked;
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="unlock-instance_method">
  <h3 class='signature '>
    #<strong>unlock</strong>  &#x21d2; <code>self</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Releases the lock. Raises <a href="../ThreadError.html" title="ThreadError (class)">::ThreadError</a> if <code>mutex</code> wasn&#39;t locked by the
current thread.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L368-L379'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num'>


368
369
370
371
372
373
374
375
376
377
378
379</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 368</span></pre>
<pre class='code cpp'>

VALUE
rb_mutex_unlock(VALUE self)
{
    const char *err;
    rb_mutex_t *mutex;
    GetMutexPtr(self, mutex);

    err = rb_mutex_unlock_th(mutex, GET_THREAD());
    if (err) rb_raise(rb_eThreadError, &quot;%s&quot;, err);

    return self;
}
</pre>
  </div>
</div>
</section>


<div id='footer'>
  Generated by
  <a href='http://yardoc.org' title='Yay! A Ruby Documentation Tool' target="_parent">yard</a>
  0.9.8 with <a href='https://msp-greg.github.io/yard-t2/' title='yard-t2' target="_parent">yard-t2</a> 0.9.0 (ruby-2.5.0p-1)
</div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>